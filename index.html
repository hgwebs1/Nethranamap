<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Nethrana Open Map</title>
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
  <style>
    html,body{margin:0;height:100%;font-family:Inter,Roboto,Arial,sans-serif;}
    #map{position:absolute;left:380px;top:0;right:0;bottom:0;}
    #sidebar{position:absolute;left:0;top:0;bottom:0;width:380px;background:#fff;border-right:1px solid #ddd;
      padding:10px;overflow:auto;box-sizing:border-box;}
    h1{margin:0;font-size:18px;}
    .btn{background:#1a73e8;color:#fff;border:0;padding:7px 10px;border-radius:6px;margin:4px 4px 4px 0;cursor:pointer;}
    .btn.gray{background:#666;}
    textarea{width:100%;height:200px;font-family:monospace;font-size:13px;}
  </style>
</head>
<body>
<div id="sidebar">
  <h1>Nethrana Open Map</h1>
  <p>Fully open-source Carto raster map + JSON viewer/editor</p>
  <div>
    <button class="btn" id="gotoNethrana">Go to Nethrana</button>
    <button class="btn" id="gotoKothari">Go to Kothari</button>
    <button class="btn" id="gotoRupawas">Go to Rupawas</button>
    <button class="btn gray" id="routeBtn">Route to Selected</button>
  </div>
  <p><b>Feature JSON</b></p>
  <textarea id="jsonBox" placeholder="Click any feature..."></textarea><br/>
  <button class="btn" id="applyBtn">Apply Edit</button>
  <button class="btn gray" id="saveBtn">Save Local</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
<script>
// ---------- Map Setup ----------
const map = new maplibregl.Map({
  container: 'map',
  style: {
    "version": 8,
    "sources": {
      "carto": {
        "type": "raster",
        "tiles": [
          "https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png"
        ],
        "tileSize": 256,
        "attribution": "&copy; OpenStreetMap & Carto"
      }
    },
    "layers": [{ "id": "carto", "type": "raster", "source": "carto" }]
  },
  center: [73.344, 27.7425],
  zoom: 14
});
map.addControl(new maplibregl.NavigationControl(), 'top-right');

// ---------- Load GeoJSON ----------
fetch('nethrana.json')
  .then(r => r.json())
  .then(data => {
    window.GEO = data;
    map.addSource('villages', { type: 'geojson', data: GEO });

    // polygons
    map.addLayer({
      id: 'polygons',
      type: 'fill',
      source: 'villages',
      filter: ['==', ['geometry-type'], 'Polygon'],
      paint: {
        'fill-color': ['match', ['get', 'type'],
          'water', '#9ddcff',
          'boundary', '#c7d2fe',
          '#f1f5f9'
        ],
        'fill-opacity': 0.5
      }
    });
    // lines
    map.addLayer({
      id: 'lines',
      type: 'line',
      source: 'villages',
      filter: ['==', ['geometry-type'], 'LineString'],
      paint: { 'line-color': '#f97316', 'line-width': 3 }
    });
    // points
    map.addLayer({
      id: 'points',
      type: 'circle',
      source: 'villages',
      filter: ['==', ['geometry-type'], 'Point'],
      paint: {
        'circle-color': [
          'match',
          ['get', 'type'],
          'village', '#2563eb',
          'temple', '#a855f7',
          'clinic', '#10b981',
          'school', '#facc15',
          'shop', '#fb923c',
          'house', '#737373',
          '#000'
        ],
        'circle-radius': 7,
        'circle-stroke-color': '#fff',
        'circle-stroke-width': 1
      }
    });
    // labels
    map.addLayer({
      id: 'labels',
      type: 'symbol',
      source: 'villages',
      layout: {
        'text-field': ['get', 'name'],
        'text-offset': [0, 1.1],
        'text-anchor': 'top',
        'text-size': 13
      },
      paint: { 'text-color': '#111' }
    });

    // clicks â†’ JSON
    map.on('click', e => {
      const feats = map.queryRenderedFeatures(e.point, { layers: ['points', 'lines', 'polygons'] });
      if (!feats.length) return;
      const f = feats[0];
      document.getElementById('jsonBox').value = JSON.stringify(f, null, 2);
      window.currentFeature = f;
    });
  });

// ---------- FlyTo buttons ----------
function flyToVillage(name) {
  const feat = GEO.features.find(f => f.properties.name === name);
  if (feat) map.flyTo({ center: feat.geometry.coordinates, zoom: 15 });
}
document.getElementById('gotoNethrana').onclick = () => flyToVillage('Nethrana');
document.getElementById('gotoKothari').onclick = () => flyToVillage('Kothari');
document.getElementById('gotoRupawas').onclick = () => flyToVillage('Rupawas');

// ---------- Apply & Save ----------
document.getElementById('applyBtn').onclick = () => {
  try {
    const obj = JSON.parse(document.getElementById('jsonBox').value);
    const id = obj.properties.id;
    const i = GEO.features.findIndex(x => x.properties.id === id);
    if (i >= 0) GEO.features[i] = obj;
    map.getSource('villages').setData(GEO);
    alert("Changes applied.");
  } catch (e) { alert("Invalid JSON"); }
};
document.getElementById('saveBtn').onclick = () => {
  localStorage.setItem('nethrana_geo', JSON.stringify(GEO));
  alert("Saved locally");
};

// ---------- Routing (free logic-based) ----------
const routeSource = { type: 'FeatureCollection', features: [] };
map.on('load', () => {
  map.addSource('route', { type: 'geojson', data: routeSource });
  map.addLayer({
    id: 'routeLine',
    type: 'line',
    source: 'route',
    paint: { 'line-color': '#1a73e8', 'line-width': 4 }
  });
});
document.getElementById('routeBtn').onclick = () => {
  if (!window.currentFeature) { alert("Click any feature first"); return; }
  const start = [73.341, 27.743];
  const end = window.currentFeature.geometry.coordinates;
  const route = {
    type: "Feature",
    properties: { name: "Approx Route" },
    geometry: { type: "LineString", coordinates: [start, end] }
  };
  routeSource.features = [route];
  map.getSource('route').setData(routeSource);
};
</script>
</body>
</html>